apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: eei-build-pipeline
  labels:
    app: pipeline-eei
    demo: eei
spec:
  workspaces:
    - name: git-source
  tasks:
    - name: git-clone-eei
      taskRef:
        name: git-clone
        kind: ClusterTask
      params:
        - name: url
          value: "{{FORKED_REPO}}"
        - name: subdirectory
          value: ""
        - name: deleteExisting
          value: "true"
        - name: revision
          value: "{{BRANCH}}"
      workspaces:
        - name: output
          workspace: git-source

    - name: build-simulator-image
      runAfter:
        - git-clone-eei
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: build
            image: quay.io/buildah/stable:latest
            securityContext:
              privileged: true
            script: |
              buildah --storage-driver vfs bud \
                -f /workspace/git-source/EventEnabledInsurance/QuoteLifecycleSimulator/Simulator.Dockerfile \
                -t image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/quote-simulator-eei:latest \
                /workspace/git-source/EventEnabledInsurance/QuoteLifecycleSimulator
              buildah --storage-driver vfs push \
                --tls-verify=false \
                image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/quote-simulator-eei:latest
      workspaces:
      - name: git-source
        workspace: git-source

    - name: deploy-simulator-app
      runAfter:
        - build-simulator-image
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: oc
            image: quay.io/openshift/origin-cli:latest
            script: "/workspace/git-source/EventEnabledInsurance/QuoteLifecycleSimulator/deploy.sh -n {{NAMESPACE}}"
      workspaces:
      - name: git-source
        workspace: git-source

    - name: build-projection-claims-image
      runAfter:
        - git-clone-eei
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: build
            image: quay.io/buildah/stable:latest
            securityContext:
              privileged: true
            script: |
              buildah --storage-driver vfs bud \
                -f /workspace/git-source/EventEnabledInsurance/ProjectionClaims/Dockerfile \
                -t image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/projection-claims-eei:latest \
                /workspace/git-source/EventEnabledInsurance/ProjectionClaims
              buildah --storage-driver vfs push \
                --tls-verify=false \
                image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/projection-claims-eei:latest
      workspaces:
      - name: git-source
        workspace: git-source

    - name: deploy-projection-claims-app
      runAfter:
        - build-projection-claims-image
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: oc
            image: quay.io/openshift/origin-cli:latest
            script: "/workspace/git-source/EventEnabledInsurance/ProjectionClaims/deploy.sh -n {{NAMESPACE}}"
      workspaces:
      - name: git-source
        workspace: git-source

    - name: build-mq-image
      runAfter:
        - git-clone-eei
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: build
            image: quay.io/buildah/stable:latest
            securityContext:
              privileged: true
            script: |
              buildah --storage-driver vfs bud \
                -f /workspace/git-source/EventEnabledInsurance/MQ/Dockerfile \
                -t image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/mq-eei:latest \
                /workspace/git-source/EventEnabledInsurance/MQ
              buildah --storage-driver vfs push \
                --tls-verify=false \
                image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/mq-eei:latest
      workspaces:
      - name: git-source
        workspace: git-source

    - name: deploy-mq
      runAfter:
        - build-mq-image
      taskSpec:
        workspaces:
          - name: git-source
        steps:
          - name: oc
            image: quay.io/openshift/origin-cli:latest
            script: "/workspace/git-source/products/bash/release-mq.sh -n {{NAMESPACE}} -r mq-eei -i image-registry.openshift-image-registry.svc:5000/{{NAMESPACE}}/mq-eei:latest -q eei"
      workspaces:
      - name: git-source
        workspace: git-source

    # build ace rest
    - name: build-ace-rest
      runAfter:
        - git-clone-eei
      taskRef:
        name: build-task
      params:
        - name: imageTag
          value: "latest"
        - name: imageName
          value: "ace-rest-eei"
        - name: dockerfile
          value: "../../../EventEnabledInsurance/ACE/ACE-REST.Dockerfile"
        - name: contextPath
          value: "../EventEnabledInsurance/Bar_files/REST"
        - name: pvc
          value: "buildah-ace-rest-eei"
      workspaces:
        - name: git-source
          workspace: git-source

    # build ace db-writer
    - name: build-ace-db-writer
      runAfter:
        - git-clone-eei
      taskRef:
        name: build-task
      params:
        - name: imageTag
          value: "latest"
        - name: imageName
          value: "ace-db-writer-eei"
        - name: dockerfile
          value: "../../../EventEnabledInsurance/ACE/ACE-DB-WRITER.Dockerfile"
        - name: contextPath
          value: "../EventEnabledInsurance/Bar_files/DB-WRITER"
        - name: pvc
          value: "buildah-ace-db-writer-eei"
      workspaces:
        - name: git-source
          workspace: git-source

    # deploy ace rest
    - name: deploy-ace-rest
      runAfter:
        - build-ace-rest
      taskRef:
        name: deploy-task
      params:
        - name: imageTag
          value: "latest"
        - name: imageName
          value: "ace-rest-eei"
        - name: releaseName
          value: "ace-rest-int-srv-eei"
        - name: releaseScript
          value: release-ace-integration-server.sh -e
        - name: namespace
          value: "{{NAMESPACE}}"
      workspaces:
        - name: git-source
          workspace: git-source

    # deploy ace db_writer
    - name: deploy-db-writer
      runAfter:
        - build-ace-db-writer
      taskRef:
        name: deploy-task
      params:
        - name: imageTag
          value: "latest"
        - name: imageName
          value: "ace-db-writer-eei"
        - name: releaseName
          value: "ace-db-writer-int-srv-eei"
        - name: releaseScript
          value: release-ace-integration-server.sh -e
        - name: namespace
          value: "{{NAMESPACE}}"
      workspaces:
        - name: git-source
          workspace: git-source
